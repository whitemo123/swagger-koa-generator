"use strict";var e=require("ejs"),t=require("axios"),r=require("fs");require("path");var o=require("fs-extra"),s=require("js-beautify"),i=require("faker"),n=require("moment");function a(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}const l=t.create({});var c={get:(e,t)=>{return r={url:e,params:t},new Promise(((e,t)=>{l.request(r).then((t=>{e(t.data)})).catch((e=>{t(e)}))}));var r}};const p=r;var u={createFile:function(e){p.writeFileSync(e,"")},fileExists:function(e){return p.existsSync(e)}};const h=i,m=n;function g(e,t){return"integer"===t.type&&"id"!==e?"page"===e?1:"limit"===e?10:"totalPage"===e||"total"===e?1:0:"boolean"===t.type||("string"===t.type||"id"===e?"date-time"===t.format?m(h.datatype.datetime()).format("YYYY-MM-DD kk:mm:SS"):-1!=e.indexOf("Name")||"name"===e?h.commerce.productName():"id"===e?"1655757911382560770":"1":"object"===t.type&&t.additionalProperties?{}:void 0)}function w(e,t){const r=e.split("/"),o=r[r.length-1];let s=JSON.parse(JSON.stringify(t[o]));if(!s)return null;const i={};for(const e in s.properties){let t=s.properties[e];i[e]=g(e,t)}return[i]}var d={getResponse:function e(t,r){if(!t||!r)return null;const o=t.split("/"),s=o[o.length-1];let i=JSON.parse(JSON.stringify(r[s]));return i?("object"===i.type&&(i=function(t){let o={};for(const s in t){const i=t[s];i.$ref?o[s]=e(i.$ref,r):"array"===i.type?i.items.$ref?o[s]=w(i.items.$ref,r):"string"===i.items.type?o[s]=["1"]:"integer"===i.items.type&&(o[s]=[1]):o[s]=g(s,i)}return o}(i.properties)),i):null},mockCommonData:g,getArrayResponse:w};const f=e,{get:y}=c,{fileExists:$}=u,j=o,N=s,{getResponse:D}=d;var E=a(class{#e={};#t=[];#r="";constructor(e,t){if(!e.projectName)throw new Error("please input your projectName");if(!e.workspace)throw new Error("please input your workspace");if($(e.workspace+"/"+e.projectName))throw new Error(`${e.workspace}/${e.projectName} is exist`);if(!e.swaggerUrl)throw new Error("please input your swaggerUrl");if(!t)throw new Error("currentDir is null");e.swaggerUrl=e.swaggerUrl.replace("/doc.html",""),this.#e=e,this.#r=t}async#o(){this.#s("开始获取模块集合");try{const e=await y(this.#e.swaggerUrl+"/v3/api-docs/swagger-config");let t=[];if(!e.urls||0===e.urls.length)throw new Error("modules为空");t=e.urls.map((e=>e.name)),this.#t=t,console.log(this.#t),this.#s("完成获取模块集合")}catch(e){throw new Error(e)}}async#i(){this.#s("开始创建项目文件"),await j.copySync(`${this.#r}templates`,`${this.#e.workspace}/${this.#e.projectName}`),await this.#n(`${this.#r}static/app.ejs`,`${this.#e.workspace}/${this.#e.projectName}/app.js`,{needApi:this.#e.needApi}),this.#s("生成app.js完毕"),this.#s("完成创建项目文件")}async#a(e,t,r){return new Promise((async t=>{await this.#n(`${this.#r}static/router.ejs`,`${this.#e.workspace}/${this.#e.projectName}/routes/${e}/index.js`,{routes:r}),t(null)}))}#l(e){return{method:e.get?"get":e.post?"post":e.put?"put":"delete",data:e.get||e.post||e.put||e.delete}}async#c(e){return this.#s("开始创建"+e+"模块文件"),new Promise((async t=>{try{const r=await y(`${this.#e.swaggerUrl}/v3/api-docs/${e}`);let o=r.paths,s=r.components.schemas;const i=[];for(let e in o){const t=this.#l(o[e]).data;let r="";r=-1!=e.indexOf("{")?e.replace(/{([^}]+)}/g,":$1"):e,i.push({url:r,method:this.#l(o[e]).method,summary:`${t.tags[0]}${t.summary}`,res:D(t?.responses[200]?.content["*/*"]?.schema?.$ref||"",s)})}await this.#a(e,{},i),this.#s("完成创建"+e+"模块文件"),t(null)}catch(e){throw new Error(e)}}))}async#p(){this.#s("开始创建模块文件");let e=this.#t.map((e=>this.#c(e)));return new Promise((t=>{Promise.all(e).then((e=>{this.#s("完成创建模块文件"),t(null)}))}))}#n(e,t,r){return new Promise((o=>{f.renderFile(e,r,((e,r)=>{if(e)throw new Error(e);j.createFileSync(t);const s=j.writeFileSync(t,N.js(r,{indent_size:2,space_in_empty_paren:!0}));if(s)throw new Error(s);o(null)}))}))}#s(e){console.log("======== "+e+" ========")}async generate(){await this.#o(),await this.#i(),await this.#p()}});module.exports=E;
